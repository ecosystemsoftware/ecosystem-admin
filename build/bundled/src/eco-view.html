<html><head><link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-route/app-route.html">

<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../bower_components/vaadin-combo-box/vaadin-combo-box.html">

<link rel="import" href="eco-list-block.html">
<link rel="import" href="eco-field-block.html">
<link rel="import" href="eco-behaviors.html">

<link rel="import" href="eco-bundle-imports.html">

</head><body><dom-module id="eco-view">
    <template>

        <style include="custom-styles">

        </style>

        



        
        <iron-ajax auto="" id="viewBlocksRequest" method="GET" url="/bundles/[[ schemaData.id ]]/[[ queries.view ]].json" handle-as="json" last-response="{{ viewBlocks }}"></iron-ajax>

            
            <iron-ajax auto="" id="viewListRequest" method="GET" url="/views" handle-as="json" last-response="{{ viewsAvailable }}"></iron-ajax>

            
            <iron-ajax id="recordRequest" headers="[[ _getJWT(jwt) ]]" url="[[ apiRoot ]]/[[ schemaData.id ]]/[[ tableData.id ]]/[[ recordData.id ]]" handle-as="json" last-response="{{record}}" debounce-duration="300"></iron-ajax>

                
                <iron-ajax headers="[[ _getJWT(jwt) ]]" id="actionRequest" handle-as="json" content-type="application/json"></iron-ajax>

                <app-route route="{{route}}" pattern="/:id" data="{{schemaData}}" tail="{{subroute}}" query-params="{{ queries }}">
                </app-route>

                <app-route route="{{subroute}}" pattern="/:id" data="{{tableData}}" tail="{{subsubroute}}">
                </app-route>

                <app-route route="{{subsubroute}}">
                </app-route>


                <app-toolbar>
                    
                    <paper-toggle-button checked="{{ globalAllowEdit }}">
                        <iron-icon icon="editor:mode-edit"></iron-icon>
                    </paper-toggle-button>

                    <div main-title=""></div>

                    
                    <vaadin-combo-box label="Choose a view" value="{{ queries.view }}" item-label-path="description" item-value-path="name" items="[[ _getAvailableViewsForThisTable(viewsAvailable, schemaData, tableData, recordData) ]]"></vaadin-combo-box>

                </app-toolbar>

                
                <paper-toast horizontal-align="right" id="updateConfirmationToast"></paper-toast>

                
                <template is="dom-repeat" items="[[ viewBlocks ]]" as="block">

                    
                    
                    <template is="dom-if" if="[[ _isListBlock(block) ]]">
                        <eco-list-block jwt="[[ jwt ]]" global-allow-edit="[[ globalAllowEdit ]]" schema="[[ _getSchema(schemaData.id, block) ]]" table="[[ _getTable(tableData.id, block) ]]" restrict-record="[[ recordData.id ]]" block-config="[[ block ]]"></eco-list-block>
                    </template>

                    <template is="dom-if" if="[[ !_isListBlock(block) ]]">
                        <eco-field-block global-allow-edit="[[ globalAllowEdit ]]" block-config="[[ block ]]" model="[[ record ]]" config="[[ config ]]"></eco-field-block>
                    </template>

                </template>


    </template>

    <script>Polymer({is:"eco-view",behaviors:[EcoBehaviors.ApiBehavior,EcoCustom.Properties,EcoCustom.Actions],properties:{route:{type:Object},globalAllowEdit:{type:Boolean,value:!1,notify:!0},schemaData:Object,tableData:Object,recordData:{type:Object,computed:"_getRecordId(subsubroute)"},viewBlocks:{type:Array},viewsAvailable:{type:Object},jwt:String,config:Object},listeners:{"viewBlocksRequest.error":"_errorLoadingViewBlocks",blockUpdated:"_updatedOK",showMessage:"_showMessage","actionRequest.response":"_updatedOK","actionRequest.error":"_updateError",recordUpdated:"_updateRecord"},observers:["_recordChanged(recordData.id)"],_getRecordId:function(e){return e.path?(recordId=e.path.split("/"),recordId?{id:recordId[1]}:{id:null}):{id:null}},_errorLoadingViewBlocks:function(){this.queries.view?this._message("Error loading view: "+this.queries.view+". Check that the view file exists"):this._message("No view was specified.  Unable to display data.")},_updatedOK:function(e){this._message("Action Completed");var t=Polymer.dom(this.root).querySelectorAll("eco-list-block");for(i=0;i<t.length;i++)t[i].refresh();var o=Polymer.dom(this.root).querySelectorAll("eco-field-block");o.length>0&&this.$.recordRequest.generateRequest()},_updateError:function(e){this._message("Action could not be completed")},_message:function(e){this.$.updateConfirmationToast.text=e,this.$.updateConfirmationToast.open()},_showMessage:function(e){this._message(e.detail.text)},_isListBlock:function(e){return"list"==e.type},_getAvailableViewsForThisTable:function(e,t,o,i){var r=e[t.id][o.id];return i.id&&r?r.record:r?r.list:[]},_updateRecord:function(e){this.$.actionRequest.method="PATCH",this.$.actionRequest.url=this.apiRoot+"/"+this.schemaData.id+"/"+this.tableData.id+"/"+this.recordData.id,postBody={},postBody[e.detail.fieldUpdated]=e.detail.newValue,this.$.actionRequest.body=postBody,this.$.actionRequest.generateRequest()},_recordChanged:function(e){e&&this.$.recordRequest.generateRequest()},_getTable:function(e,t){return t.table||e},_getSchema:function(e,t){return t.schema||e}});</script>
</dom-module></body></html>