<html><head><link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/editor-icons.html">

<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">

<link rel="import" href="eco-behaviors.html">



</head><body><dom-module id="eco-list-block">

    <template>

        <style include="custom-styles">
        
            :host {
                display: block;
                margin: 0.5em;
                color: black;
                background-color: #fff;
                box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
                padding: 0.5em;
            }

            .title {
                font-size: 125%;
                font-weight: bold;
                border-bottom: 0.1em solid black;
                margin-bottom: 0.5em;
                padding-bottom: 0.5em;
                color: var(--primary-text-color);
            }

            .content tr {
               border-bottom: solid 1px black; 
            }

            th.active-ordered paper-icon-button {
                color: var(--primary-color);
            }

            th.active-ordered.desc paper-icon-button {
                -webkit-transform: rotate(180deg);
                -moz-transform: rotate(180deg);
                -o-transform: rotate(180deg);
                -ms-transform: rotate(180deg);
                transform: rotate(180deg);
            }

            img.line-image {
                max-height: 35px;
                max-width: 50px; 
            }

            paper-input.cellInput {
                --paper-input-container: {
                    padding: 0px 0px 0px 0px;
                };
                --paper-input-container-underline: {
                    display: none;
                };
                --paper-input-container-underline-focus: {
                    display: none;
                };
                --paper-input-container-input: {
                    font-size: 100%;
                    color: black;
                };
            }

            .listCell {
                background-color:#FbFbFb;
				opacity: 0.8;
                padding: 0.3em 1em 0.3em 1em;
            }

            .listCellContentContainer {
                overflow: hidden;
                display: -webkit-box;
                -webkit-line-clamp: 3;
                -webkit-box-orient: vertical;
            }

            .listCell.cellEdittrue {
                background-color: #f8f8f8;
                padding: 0.3em 1em 0.3em 1em;
            }

            a {
                color: var(--primary-color);
            }

            paper-icon-button {
                color: var(--icon-button-color);
            }


        </style>


<iron-ajax headers="[[ _getJWT(jwt) ]]" auto="" id="listRequest" method="GET" params="[[ params ]]" url="[[ apiRoot ]]/[[ schema ]]/[[ table ]]" handle-as="json" last-response="{{ rows }}" debounce-duration="300"></iron-ajax>

<iron-ajax headers="[[ _getJWT(jwt) ]]" id="actionRequest" handle-as="json" content-type="application/json"></iron-ajax>

<iron-ajax method="POST" body="[[ newRecord ]]" url="[[ apiRoot ]]/[[ schema ]]/[[ table ]]" headers="[[ _getJWT(jwt) ]]" id="newRecordRequest" handle-as="json" content-type="application/json"></iron-ajax>

<div class="title">
    [[ title ]]
</div>

<template is="dom-if" if="[[ keywordFilter ]]">
    <paper-input type="text" error-message="Invalid input!" min="3" label="Filter by [[ keywordFilterTitle ]]" value="{{ searchTerm }}">
        <iron-icon prefix="" icon="search"></iron-icon>
    </paper-input>
</template>


<paper-dialog id="newDialog">
    <h2>Add New Entry to [[ title ]]</h2>
    <p>
        Enter the following required fields in order to create a new record.
    </p>
    <p>
        <template is="dom-repeat" items="[[ requiredFieldsForNew ]]" as="requiredField">
            <paper-input type="text" label="[[ requiredField.label ]]" on-change="_newRecordFieldChanged"></paper-input>
        </template>
        <paper-button raised="" on-tap="_createNew">Add</paper-button>
    </p>

</paper-dialog>

<span hidden$="[[ !_showArray(requiredFieldsForNew) ]]"><paper-icon-button icon="add-circle" on-tap="_showNewDialog"></paper-icon-button></span>


<template is="dom-repeat" items="[[ bulkActions ]]" as="action">
    <paper-button raised="" disabled$="[[ !numberOfLinesSelected ]]" on-tap="_runBulkAction">[[ action.label ]]</paper-button>
</template>

<table class="eco-grid" hidden$="[[ !_showTable(searchTerm, hideIfNoKeyword) ]]">
    <thead>
        <tr>
            
            <template is="dom-if" if="[[ allowSelect ]]">
                <th></th>
            </template>
            
            <template is="dom-if" if="[[ showImage ]]">
                <th></th>
            </template>
            
            <template is="dom-repeat" items="[[ dataColumns ]]" as="column">
                <th class$="[[ _isActiveOrdered(column, params.orderBy) ]]">[[ column.label ]]
                    <span hidden$="[[ !allowSort ]]">
                        <paper-icon-button icon="filter-list" on-tap="_toggleOrder">
                        </paper-icon-button>
                    </span>
                </th>
            </template>
            
            <template is="dom-repeat" items="[[ actionColumns ]]" as="column">
                <th> [[ column.label ]]</th>
            </template>
        </tr>
    </thead>
    <tbody hidden$="[[ !rows ]]">
        <template id="mainlist" is="dom-repeat" items="[[ rows ]]" as="row">
            <tr>
                
                <template is="dom-if" if="[[ allowSelect ]]">
                    <td>
                        <paper-checkbox class="bulkselection-checkbox" on-change="_bulkSelectChanged"></paper-checkbox>
                    </td>
                </template>
                
                <template is="dom-if" if="[[ showImage ]]">
                    <td><img class="line-image" src="[[ publicApiRoot ]]/images/[[ schema ]]/[[ _selectImage(row) ]]?width=100"></td>
                </template>
                
                <template is="dom-repeat" items="[[ dataColumns ]]" as="column">
                    <td class$="listCell cellEdit[[ _showEdit(column, globalAllowEdit) ]]">
                        <template is="dom-if" if="[[ column.linkTo ]]">
                            <a href="/admin/view/[[ column.linkSchema ]]/[[ column.linkTable ]]/[[ _getLink(row,column) ]][[ _getView(column) ]]">
                                        [[ _getCell(row,column) ]]
                                        </a>
                        </template>
                        <template is="dom-if" if="[[ !column.linkTo ]]">
                            <template is="dom-if" if="[[ _showEdit(column, globalAllowEdit) ]]">
                                <paper-input label="Edit [[ _getCell(row,column) ]]" class="cellInput" type="[[ column.edit.type ]]" value="[[ _getCell(row,column) ]]" on-change="_emitLineUpdateEvent"></paper-input>
                            </template>
                            <template is="dom-if" if="[[ !_showEdit(column, globalAllowEdit) ]]">
                                <div class="listCellContentContainer">
                                    [[ _getCell(row,column) ]]
                                </div>

                            </template>

                        </template>
                    </td>
                </template>
                
                <template is="dom-repeat" items="[[ actionColumns ]]" as="column">
                    <td>
                        <paper-icon-button icon$="[[ column.icon ]]" on-tap="_runLineAction">
                    </paper-icon-button></td>
                </template>
            </tr>
        </template>
    </tbody>
</table>

<div style="text-align:center; padding: 1em; font-size: large" hidden$="[[ rows ]]"> Loading [[ title ]] ...
</div>

<array-selector id="selector" items="{{rows}}" selected="{{bulkSelection}}" multi="" toggle=""></array-selector>

<content></content>



</template>

<script>Polymer({is:"eco-list-block",behaviors:[EcoBehaviors.ApiBehavior,EcoCustom.Properties,EcoCustom.Actions],properties:{jwt:String,globalAllowEdit:{type:Boolean,value:!1},table:{type:String,observer:"_resetRows"},schema:{type:String,observer:"_resetRows"},restrictRecord:{type:String,observer:"_restrict"},restrictField:String,title:String,dataColumns:Array,actionColumns:Array,bulkActions:Array,requiredFieldsForNew:{type:Array,value:function(){return[]}},params:{type:Object,value:function(){return{orderBy:"id",limit:"100"}}},searchTerm:{type:String,observer:"_searchTermUpdated"},allowSort:{type:Boolean,value:!1},allowSelect:{type:Boolean,value:!1},confirmLineActions:{type:Boolean,value:!0},showImage:{type:Boolean,value:!1},hideIfNoKeyword:{type:Boolean,value:!1},keywordFilter:{type:String},blockConfig:{type:Object,observer:"_setBlockConfig"},bulkSelection:{type:Array,reflectToAttribute:!0,notify:!0},newRecord:{type:Object,value:function(){return{}}},newRecordLinkView:String},observers:["_bulkSelectionChanged(bulkSelection.splices)"],listeners:{updateLine:"_updateLine","actionRequest.response":"_updateAll","listRequest.response":"_listUpdated","newRecordRequest.response":"_newRecordCreated","newRecordRequest.error":"_newRecordNotCreated"},_selectImage:function(e){return e.images=e.images||[],e.image||e.images[0]},_showTable:function(e,t){return e||!t},_restrict:function(e){if(this.restrictField){var t="params."+this.restrictField;this.set(t,"='"+e+"'")}},_setBlockConfig:function(e){this.title="",this.dataColumns=[],this.actionColumns=[],this.bulkActions=[],this.params={orderBy:"id",limit:"100"},this.allowSort=!1,this.allowSelect=!1,this.confirmLineActions=!1,this.showImage=!1,this.keywordFilter="",this.keywordFilterTitle="",this.searchTerm="",this.requiredFieldsForNew=[],Object.assign(this,e)},_resetRows:function(){this.set("rows",[])},_runLineAction:function(e){var t="Are you sure you want to "+e.model.__data__.column.label,i=!this.confirmLineActions||confirm(t);if(i){var o=this[e.model.__data__.column.actionFunction];if(o){var n=e.model.dataHost.dataHost.__data__.row;o(n,this)}else this.fire("showMessage",{text:"Error: No action or incorrect action specified"})}},deleteLine:function(e,t){t.$.actionRequest.method="DELETE",t.$.actionRequest.url=t.apiRoot+"/"+t.schema+"/"+t.table+"/"+e.id,t.$.actionRequest.generateRequest()},_showNewDialog:function(){this.$.newDialog.open()},_newRecordFieldChanged:function(e){var t=Polymer.dom(e),i="newRecord."+e.model.__data__.requiredField.name,o=t.rootTarget.__data__.value||t.event.target.__data__.bindValue;this.set(i,o)},_createNew:function(e){this.$.newRecordRequest.generateRequest()},_newRecordCreated:function(e){window.location="/admin/view/"+this.schema+"/"+this.table+"/"+e.detail.__data__.response.id+"?view="+this.newRecordLinkView},_newRecordNotCreated:function(e){console.log(e)},_runBulkAction:function(e){var t="Are you sure you want to "+e.model.__data__.action.label,o=!e.model.__data__.action.confirm||confirm(t);if(o){var n=this[e.model.__data__.action.actionFunction];if(n){var r=this.bulkSelection;for(i=0;i<r.length;i++)n(r[i],this)}else this.fire("showMessage",{text:"Error: No action or incorrect action specified"})}},_searchTermUpdated:function(){this.searchTerm&&(p="params."+this.keywordFilter,this.set(p,"ILIKE '%"+this.searchTerm+"%'"))},_updateAll:function(e){this.fire("blockUpdated")},refresh:function(){this.$.listRequest.generateRequest()},_showEdit:function(e,t){return e.edit&&t},_showArray:function(e){return e.length>0},_bulkSelectionChanged:function(){this.set("numberOfLinesSelected",this.bulkSelection.length)},_listUpdated:function(){this._clearBulkSelection(),this.dataColumns||this._setDefaultDataColumns()},_setDefaultDataColumns:function(){defaultDataColumns=[],firstRow=this.rows[0];for(var e in firstRow)defaultDataColumns.push({name:e,heading:e.replace(/_|-/gi," ").toUpperCase()});this.set("dataColumns",defaultDataColumns)},_clearBulkSelection:function(){var e=document.getElementsByClassName("bulkselection-checkbox");for(i=0;i<e.length;i++)e[i].removeAttribute("checked")},_getCell:function(e,t){return e[t.name]},_getLink:function(e,t){return e[t.linkTo]},_getView:function(e){return e.linkView?"?view="+e.linkView:""},_testIf:function(e){return!0},_toggleOrder:function(e){this.params.orderBy==e.model.__data__.column.name?this.set("params.orderBy",e.model.__data__.column.name+" DESC"):this.set("params.orderBy",e.model.__data__.column.name)},_isActiveOrdered:function(e,t){return t==e.name?"active-ordered":t.includes(e.name)?"active-ordered desc":void 0},_isSelected:function(e,t){console.log(e),console.log(t.id)},_bulkSelectChanged:function(e){var t=this.$.mainlist.itemForElement(e.target);e.target.checked?this.$.selector.select(t):this.$.selector.deselect(t)},_emitLineUpdateEvent:function(e){var t=Polymer.dom(e);this.debounce("actionRequest",function(){this.fire("updateLine",{lineUpdated:t.event.model.__data__.row.id,fieldUpdated:t.event.model.__data__.column.name,newValue:t.rootTarget.__data__.value||t.event.target.__data__.bindValue})},300)},_updateLine:function(e){this.$.actionRequest.method="PATCH",this.$.actionRequest.url=this.apiRoot+"/"+this.schema+"/"+this.table+"/"+e.detail.lineUpdated,postBody={},postBody[e.detail.fieldUpdated]=e.detail.newValue,this.$.actionRequest.body=postBody,this.$.actionRequest.generateRequest()}});</script>

</dom-module></body></html>